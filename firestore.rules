rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Posts 컬렉션 규칙
    match /posts/{postId} {
      // 읽기: 모든 사용자 허용
      allow read: if true;
      
      // 생성: 모든 사용자 허용 (필수 필드 검증)
      allow create: if request.resource.data.keys().hasAll(['title', 'content', 'category', 'author', 'views', 'createdAt', 'updatedAt'])
                   && request.resource.data.title is string
                   && request.resource.data.title.size() > 0
                   && request.resource.data.title.size() <= 200
                   && request.resource.data.content is string
                   && request.resource.data.content.size() > 0
                   && request.resource.data.category is string
                   && request.resource.data.author is string
                   && request.resource.data.author.size() > 0
                   && request.resource.data.author.size() <= 50
                   && request.resource.data.views is int
                   && request.resource.data.views == 0
                   && request.resource.data.createdAt is timestamp
                   && request.resource.data.updatedAt is timestamp
                   && (!('imageUrls' in request.resource.data) || 
                       (request.resource.data.imageUrls is list && 
                        request.resource.data.imageUrls.size() <= 10 &&
                        request.resource.data.imageUrls.size() >= 0));
      
      // 수정: 모든 사용자 허용 (필수 필드 유지)
      allow update: if request.resource.data.diff(resource.data).unchangedKeys().hasAll(['title', 'content', 'category', 'author', 'createdAt'])
                   && request.resource.data.updatedAt is timestamp
                   && request.resource.data.title is string
                   && request.resource.data.title.size() > 0
                   && request.resource.data.content is string
                   && request.resource.data.content.size() > 0;
      
      // 삭제: 모든 사용자 허용 (나중에 인증 추가 가능)
      allow delete: if true;
    }
    
    // Comments 서브컬렉션 규칙
    match /posts/{postId}/comments/{commentId} {
      // 읽기: 모든 사용자 허용
      allow read: if true;
      
      // 생성: 모든 사용자 허용 (필수 필드 검증)
      allow create: if request.resource.data.keys().hasAll(['author', 'content', 'createdAt', 'updatedAt'])
                   && request.resource.data.author is string
                   && request.resource.data.author.size() > 0
                   && request.resource.data.author.size() <= 20
                   && request.resource.data.content is string
                   && request.resource.data.content.size() > 0
                   && request.resource.data.content.size() <= 500
                   && request.resource.data.createdAt is timestamp
                   && request.resource.data.updatedAt is timestamp;
      
      // 수정: 모든 사용자 허용 (필수 필드 유지)
      allow update: if request.resource.data.diff(resource.data).unchangedKeys().hasAll(['author', 'createdAt'])
                   && request.resource.data.updatedAt is timestamp
                   && request.resource.data.content is string
                   && request.resource.data.content.size() > 0
                   && request.resource.data.content.size() <= 500;
      
      // 삭제: 모든 사용자 허용
      allow delete: if true;
    }
    
    // 다른 컬렉션은 기본적으로 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

